{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>ID Card Group - {{ client.name }} - Adarsh ID Cards</title>
  <link rel="icon" type="image/x-icon" href="{% static 'assets/favicon.ico' %}">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'css/style.css' %}?v=12">
  <link rel="stylesheet" href="{% static 'css/common.css' %}?v=12">
  <link rel="stylesheet" href="{% static 'css/idcard-group.css' %}?v=12">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>

  {% include 'partials/sidebar.html' %}

  <!-- Main -->
  <main class="main">

    <!-- Top Navbar -->
    <header class="topbar">
      <div class="nav-left">
        <button class="sidebar-toggle" id="sidebarToggle">
          <i class="fa-solid fa-xmark"></i>
        </button>
        <div class="breadcrumb">
            <a href="{% url 'dashboard' %}" class="breadcrumb-item"><i class="fa-solid fa-house"></i> Home</a>
            <i class="fa-solid fa-chevron-right breadcrumb-sep"></i>
            <a href="{% url 'active_clients' %}" class="breadcrumb-item">Clients</a>
            <i class="fa-solid fa-chevron-right breadcrumb-sep"></i>
            <span class="breadcrumb-item">{{ client.name }}</span>
            <i class="fa-solid fa-chevron-right breadcrumb-sep"></i>
            <span class="breadcrumb-item active">ID Card Group</span>
        </div>
      </div>

      <!-- Right - Page Switch Buttons -->
      <div class="nav-right">
        <div class="page-switch-btns">
          <a href="{% url 'idcard_group' client.id %}" class="switch-btn active" title="ID Card Group">
            <i class="fa-solid fa-id-card"></i> <span>ID Card Group</span>
          </a>
          <a href="#" id="switchToGroupSetting" class="switch-btn" title="Group Setting">
            <i class="fa-solid fa-table-list"></i> <span>Group Setting</span>
          </a>
        </div>
      </div>
    </header>

    <div class="main-content">

    <!-- Action Bar -->
    <div class="action-bar">
        
        <!-- Search and Filter -->
        <div class="action-left">
            <div class="search-box">
                <i class="fa-solid fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search...">
            </div>
            <div class="filter-group">
                <div class="custom-dropdown" id="filterDropdown">
                    <button class="dropdown-toggle" id="dropdownToggle">
                        <i class="fa-solid fa-filter"></i>
                        <span id="selectedText">Filter</span>
                        <i class="fa-solid fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-options" id="dropdownOptions">
                        <div class="dropdown-option selected" data-value="all">All</div>
                        <div class="dropdown-option" data-value="pending">Pending</div>
                        <div class="dropdown-option" data-value="verified">Verified</div>
                        <div class="dropdown-option" data-value="approved">Approved</div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ID Card Tables List -->
    <div class="table-container idcard-table">
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Action</th>
                    <th>Bulk Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for table in tables %}
                <tr data-table-id="{{ table.id }}">
                    <td>
                        <strong>{{ table.name }}</strong>
                    </td>
                    <td class="action-cell">
                        <div class="action-buttons">
                            <a href="{% url 'idcard_actions' table.id %}?status=pending" class="list-btn pending-btn">
                                <i class="fa-solid fa-clock"></i> Pending
                                <span class="count-badge">{{ table.pending_count }}</span>
                            </a>
                            <a href="{% url 'idcard_actions' table.id %}?status=verified" class="list-btn verified-btn">
                                <i class="fa-solid fa-check-circle"></i> Verified
                                <span class="count-badge">{{ table.verified_count }}</span>
                            </a>
                            <a href="{% url 'idcard_actions' table.id %}?status=pool" class="list-btn pool-btn">
                                <i class="fa-solid fa-layer-group"></i> Pool
                                <span class="count-badge">{{ table.pool_count }}</span>
                            </a>
                            <a href="{% url 'idcard_actions' table.id %}?status=approved" class="list-btn approved-btn">
                                <i class="fa-solid fa-thumbs-up"></i> Approved
                                <span class="count-badge">{{ table.approved_count }}</span>
                            </a>
                            <a href="{% url 'idcard_actions' table.id %}?status=download" class="list-btn download-btn">
                                <i class="fa-solid fa-download"></i> Downloaded
                                <span class="count-badge">{{ table.download_count }}</span>
                            </a>
                        </div>
                    </td>
                    <td class="bulk-action-cell">
                        <div class="bulk-action-buttons">
                            <button class="bulk-btn reupload-btn" data-action="reupload" data-table="{{ table.id }}">
                                <i class="fa-solid fa-upload"></i> Reupload Image
                            </button>
                            <button class="bulk-btn download-all-btn" data-action="download-all" data-table="{{ table.id }}">
                                <i class="fa-solid fa-id-card"></i> Download All ID Card
                            </button>
                            <button class="bulk-btn delete-all-btn" data-action="delete-all" data-table="{{ table.id }}">
                                <i class="fa-solid fa-trash"></i> Delete All ID Cards
                            </button>
                            <button class="bulk-btn reprint-btn-action" data-action="reprint" data-table="{{ table.id }}">
                                <i class="fa-solid fa-print"></i> Reprint ID Card
                            </button>
                            <button class="bulk-btn upgrade-class-btn" data-action="upgrade" data-table="{{ table.id }}">
                                <i class="fa-solid fa-arrow-up"></i> Upgrade All Class
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="3" style="text-align: center; padding: 40px;">
                        <div class="no-groups">
                            <i class="fa-solid fa-table-list" style="font-size: 48px; color: #d1d5db; margin-bottom: 16px;"></i>
                            <h3 style="color: #6b7280; margin-bottom: 8px;">No Tables Found</h3>
                            <p style="color: #9ca3af;">This client has no ID card tables yet. Go to Group Settings to create tables.</p>
                            <a href="{% url 'group_settings' client.id %}" class="btn btn-primary" style="margin-top: 16px; display: inline-block; padding: 10px 20px; background: #3b82f6; color: white; text-decoration: none; border-radius: 6px;">
                                <i class="fa-solid fa-gear"></i> Go to Group Settings
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    </div>

  </main>

  <!-- Toast notification -->
  <div id="toast" class="toast">
    <i class="fa-solid fa-check-circle"></i>
    <span id="toastMessage">Success!</span>
  </div>

  <script src="{% static 'js/script.js' %}?v=12"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const clientId = {{ client.id }};
      const switchToGroupSettingBtn = document.getElementById('switchToGroupSetting');
      const searchInput = document.getElementById('searchInput');
      const tableBody = document.querySelector('.idcard-table tbody');

      // Group Setting button navigation
      if (switchToGroupSettingBtn) {
        switchToGroupSettingBtn.addEventListener('click', function(e) {
          e.preventDefault();
          window.location.href = `/client/${clientId}/settings/`;
        });
      }

      // Search functionality
      if (searchInput) {
        searchInput.addEventListener('input', function(e) {
          const searchTerm = e.target.value.toLowerCase();
          const rows = tableBody.querySelectorAll('tr[data-table-id]');
          
          rows.forEach(row => {
            const tableName = row.querySelector('td:first-child').textContent.toLowerCase();
            if (tableName.includes(searchTerm)) {
              row.style.display = '';
            } else {
              row.style.display = 'none';
            }
          });
        });
      }

      // Custom Dropdown functionality
      const dropdownToggle = document.getElementById('dropdownToggle');
      const dropdownOptions = document.getElementById('dropdownOptions');
      const selectedText = document.getElementById('selectedText');

      if (dropdownToggle && dropdownOptions) {
        dropdownToggle.addEventListener('click', function(e) {
          e.stopPropagation();
          dropdownOptions.classList.toggle('show');
          dropdownToggle.classList.toggle('active');
        });

        dropdownOptions.querySelectorAll('.dropdown-option').forEach(option => {
          option.addEventListener('click', function() {
            dropdownOptions.querySelectorAll('.dropdown-option').forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            selectedText.textContent = this.textContent;
            dropdownOptions.classList.remove('show');
            dropdownToggle.classList.remove('active');
          });
        });

        document.addEventListener('click', function(e) {
          if (!dropdownToggle.contains(e.target)) {
            dropdownOptions.classList.remove('show');
            dropdownToggle.classList.remove('active');
          }
        });
      }

      // Bulk action buttons click handlers
      document.querySelectorAll('.bulk-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const action = this.dataset.action;
          const tableId = this.dataset.table;
          
          if (action === 'delete-all') {
            if (confirm('Are you sure you want to delete ALL ID cards from this table? This action cannot be undone.')) {
              fetch(`/api/table/${tableId}/cards/bulk-delete/`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ delete_all: true })
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  showToast(data.message, 'success');
                  // Reload page to refresh counts
                  setTimeout(() => location.reload(), 1000);
                } else {
                  showToast(data.message, 'error');
                }
              });
            }
          } else {
            console.log(`Bulk Action: ${action} for table: ${tableId}`);
            // TODO: Implement other bulk actions
            showToast(`${action} action coming soon!`, 'info');
          }
        });
      });

      // Toast function
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        toastMessage.textContent = message;
        toast.className = 'toast show ' + type;
        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }
    });
  </script>
</body>
</html>

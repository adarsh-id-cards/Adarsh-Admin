{% load static %}
{% load custom_filters %}
<!-- Side Modal for Add/Edit/View -->
<div class="side-modal-overlay" id="sideModalOverlay">
  <div class="side-modal" id="sideModal">
    <div class="side-modal-header">
      <h3 id="sideModalTitle">
        <i class="fa-solid fa-plus"></i>
        <span>Add New Card</span>
      </h3>
      <button class="side-modal-close" id="closeSideModal" title="Close">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
    
    <div class="side-modal-body">
      <form id="cardForm">
        <!-- ========== ALL IMAGE FIELDS AT TOP ========== -->
        <div class="modal-images-section">
          <!-- All Image Fields in Grid (including PHOTO) -->
          <div class="images-grid">
            {% for field in table.fields %}
              {% check_image_field field.type field.name as is_img %}
              {% if is_img %}
              <div class="image-field-card {{ field.name|get_image_class }}" data-field-name="{{ field.name }}">
                <div class="image-field-label">{{ field.name|expand_field_name }}</div>
                <div class="image-preview-box {{ field.name|get_image_class }}" id="preview_{{ field.name|slugify }}">
                  <i class="fa-solid fa-{% if field.name|upper == 'PHOTO' %}user{% elif 'sign' in field.name|lower %}signature{% else %}image{% endif %}"></i>
                </div>
                <div class="image-field-controls">
                  <label class="image-upload-btn">
                    <input type="file" 
                           id="field_img_{{ field.name|slugify }}" 
                           name="{{ field.name }}" 
                           class="form-control image-input"
                           data-field-name="{{ field.name }}"
                           data-field-type="image"
                           data-preview-id="preview_{{ field.name|slugify }}"
                           accept="image/*" hidden>
                    <span class="btn btn-upload-field">
                      <i class="fa-solid fa-upload"></i> Upload
                    </span>
                  </label>
                </div>
                <div class="image-path-display" id="path_{{ field.name|slugify }}">No image</div>
              </div>
              {% endif %}
            {% endfor %}
          </div>
        </div>
        
        <!-- ========== TEXT FIELDS BELOW ========== -->
        <div class="form-fields-grid" id="formFieldsContainer">
          {% for field in table.fields %}
            {% check_image_field field.type field.name as is_img %}
            {% if is_img %}
              <!-- Skip image fields - handled above -->
            {% elif field.type == 'textarea' %}
            <div class="form-group full-width">
              <label for="field_{{ forloop.counter }}">{{ field.name }}</label>
              <textarea id="field_{{ forloop.counter }}" 
                        name="{{ field.name }}" 
                        class="form-control"
                        data-field-name="{{ field.name }}"
                        data-field-type="{{ field.type }}"
                        rows="3"
                        placeholder="Enter {{ field.name|lower }}..."></textarea>
            </div>
            {% elif field.type == 'date' %}
            <div class="form-group">
              <label for="field_{{ forloop.counter }}">{{ field.name }}</label>
              <input type="date" 
                     id="field_{{ forloop.counter }}" 
                     name="{{ field.name }}" 
                     class="form-control"
                     data-field-name="{{ field.name }}"
                     data-field-type="{{ field.type }}">
            </div>
            {% elif field.type == 'number' %}
            <div class="form-group">
              <label for="field_{{ forloop.counter }}">{{ field.name }}</label>
              <input type="text" 
                     id="field_{{ forloop.counter }}" 
                     name="{{ field.name }}" 
                     class="form-control"
                     data-field-name="{{ field.name }}"
                     data-field-type="{{ field.type }}"
                     placeholder="Enter {{ field.name|lower }}...">
            </div>
            {% elif field.type == 'email' %}
            <div class="form-group">
              <label for="field_{{ forloop.counter }}">{{ field.name }}</label>
              <input type="email" 
                     id="field_{{ forloop.counter }}" 
                     name="{{ field.name }}" 
                     class="form-control"
                     data-field-name="{{ field.name }}"
                     data-field-type="{{ field.type }}"
                     placeholder="Enter {{ field.name|lower }}...">
            </div>
            {% else %}
            <div class="form-group">
              <label for="field_{{ forloop.counter }}">{{ field.name }}</label>
              <input type="text" 
                     id="field_{{ forloop.counter }}" 
                     name="{{ field.name }}" 
                     class="form-control"
                     data-field-name="{{ field.name }}"
                     data-field-type="{{ field.type }}"
                     placeholder="Enter {{ field.name|lower }}...">
            </div>
            {% endif %}
          {% endfor %}
        </div>
      </form>
    </div>
    
    <div class="side-modal-footer">
      <button class="btn btn-secondary" id="cancelSideModal">
        <i class="fa-solid fa-xmark"></i> Cancel
      </button>
      <button class="btn btn-primary" id="saveSideModal">
        <i class="fa-solid fa-check"></i>
        <span>Save</span>
      </button>
    </div>
  </div>
</div>
